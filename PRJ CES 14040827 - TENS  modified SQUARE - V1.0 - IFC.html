<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wave Generator _ طراحی مدرن و کامل</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0a1929;
      --bg-dark: #071220;
      --card: #0f2438;
      --card-dark: #0a1c2e;
      --accent: #00e5ff;
      --accent-dark: #00b8d4;
      --accent-glow: rgba(0, 229, 255, 0.3);
      --muted: #8fa3b7;
      --text: #e3f2fd;
      --btn: #1a3a5a;
      --menu-bg: #0d2a42;
      --menu-hover: #1a3a5a;
      --success: #4ade80;
      --warning: #f59e0b;
      --danger: #ef4444;
      --canvas-bg: #071220;
      --canvas-grid: rgba(255,255,255,0.08);
      --canvas-accent: #00e5ff;
      --canvas-text: rgba(255,255,255,0.9);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.4);
      --shadow-xl: 0 20px 40px rgba(0,0,0,0.5);
      --shadow-accent: 0 0 20px rgba(0, 229, 255, 0.4);
      --font-primary: 'Segoe UI', Tahoma, Roboto, sans-serif;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-primary);
      background: linear-gradient(135deg, var(--bg), var(--bg-dark));
      color: var(--text);
      direction: rtl;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 24px;
      background: linear-gradient(145deg, var(--card), var(--card-dark));
      border-radius: 20px;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      z-index: 10;
    }

    h1 {
      margin: 0 0 24px;
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 i {
      font-size: 32px;
    }

    .row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .col {
      background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.1));
      padding: 20px;
      border-radius: 16px;
      flex: 1;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255,255,255,0.03);
      transition: var(--transition);
    }

    .col:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .col.small {
      flex: 0 0 380px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }

    .section-title i {
      font-size: 20px;
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .control {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    button, .icon-btn {
      cursor: pointer;
      border: 0;
      background: var(--btn);
      color: var(--muted);
      padding: 10px 16px;
      border-radius: 12px;
      transition: var(--transition);
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
    }

    button:hover, .icon-btn:hover {
      color: #fff;
      background: var(--menu-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    button:active {
      transform: translateY(0);
    }

    button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .play-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #022;
      font-weight: 600;
      box-shadow: var(--shadow-accent);
    }

    .play-btn:hover {
      background: linear-gradient(135deg, var(--accent-dark), var(--accent));
      color: #022;
      box-shadow: 0 0 25px rgba(0, 229, 255, 0.5);
    }

    .play-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none !important;
    }

    .stop-btn {
      background: var(--danger);
      color: white;
    }

    .save-btn {
      background: var(--success);
      color: white;
    }

    .seg {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .hold-menu {
      position: relative;
      display: inline-block;
    }

    .menu-panel {
      position: absolute;
      right: 0;
      top: 110%;
      background: var(--menu-bg);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 8px;
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      display: none;
      z-index: 60;
      width: 280px;
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .menu-panel.show {
      display: block;
    }

    .menu-panel button {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin: 6px 0;
      text-align: right;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.05);
      padding: 12px 16px;
      border-radius: 10px;
      color: var(--muted);
      transition: var(--transition);
    }

    .menu-panel button:hover {
      background: var(--menu-hover);
      color: #fff;
      border-color: rgba(255,255,255,0.1);
      transform: translateX(-4px);
    }

    .menu-panel button.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #022;
      font-weight: 700;
      border-color: var(--accent);
      box-shadow: var(--shadow-accent);
    }

    .menu-panel button .wave-icon {
      font-size: 16px;
      opacity: 0.8;
    }

    .menu-panel button.active .wave-icon {
      opacity: 1;
    }

    canvas {
      width: 100%;
      height: 280px;
      border-radius: 12px;
      display: block;
      background: var(--canvas-bg);
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.05);
    }

    .play-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .value-input {
      width: 100px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
      color: var(--text);
      text-align: center;
      font-family: inherit;
      font-size: 14px;
      transition: var(--transition);
    }

    .value-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .num-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .small-btn {
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 10px;
      min-width: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .option-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .chip {
      padding: 10px 16px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.05);
      color: var(--muted);
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
    }

    .chip:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }

    .chip.selected {
      background: var(--accent);
      color: #022;
      font-weight: 700;
      box-shadow: var(--shadow-accent);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .pro-section {
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      background: linear-gradient(145deg, rgba(255,255,255,0.03), transparent);
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: var(--shadow-md);
    }

    .random-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .random-item {
      padding: 8px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.05);
      transition: var(--transition);
      font-size: 14px;
    }

    .random-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }

    .random-item.sel {
      background: var(--accent);
      color: #022;
      font-weight: 700;
      box-shadow: var(--shadow-accent);
    }

    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .footer-note {
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .ton-toff-info {
      margin-top: 8px;
      font-size: 13px;
      color: var(--accent);
      text-align: center;
      padding: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .wave-btn-active {
      background: var(--accent) !important;
      color: #022 !important;
      font-weight: bold;
      border: 1px solid var(--accent-dark) !important;
      box-shadow: var(--shadow-accent);
    }

    .sweep-controls, .pause-controls {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
    }

    .sweep-controls label, .pause-controls label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .sweep-controls input[type="checkbox"], .pause-controls input[type="checkbox"] {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
    }

    .theme-container {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    
    .theme-container .theme-list {
      flex-direction: column;
      margin-top: 0;
    }
    
    .theme-container .theme-chip {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .theme-container .theme-chip.active {
      border-color: var(--accent);
      box-shadow: var(--shadow-accent);
      transform: scale(1.1);
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .status-playing {
      background: rgba(0, 229, 255, 0.2);
      color: var(--accent);
    }
    
    .status-stopped {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .footer-email {
      color: var(--accent);
      text-decoration: none;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .footer-email:hover {
      color: var(--accent-dark);
      transform: translateY(-2px);
    }

    @media (max-width: 900px){
      .row{flex-direction:column}
      .col.small{flex:1 1 auto}
      .play-controls {flex-direction: column; align-items: stretch;}
      .play-controls button {justify-content: center;}
    }
    
    @media (max-width: 600px){
      .container {padding: 16px; margin: 10px;}
      .col {padding: 16px;}
      h1 {font-size: 24px;}
    }

    @media (max-width: 480px){
      .container {margin: 5px; padding: 12px;}
      .play-controls button {font-size: 12px; padding: 8px 12px;}
      .value-input {width: 80px;}
      .theme-chip {width: 40px; height: 28px;}
    }

    .loading {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 8px;
      font-size: 12px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="theme-container">
      <div class="theme-list" id="themeList">
        <div class="theme-chip active" data-theme="dark" title="Dark — پیش‌فرض" style="background:linear-gradient(135deg,#0a1929,#071220)"></div>
        <div class="theme-chip" data-theme="light" title="Light" style="background:linear-gradient(135deg,#f5f5f5,#e0e0e0)"></div>
        <div class="theme-chip" data-theme="windows" title="Windows" style="background:linear-gradient(135deg,#0078d4,#1e3a5f)"></div>
      </div>
    </div>

    <h1><i class="fas fa-wave-square"></i> Wave Generator </h1>
    <div class="row">
      <div class="col small">
        <div class="section-title">
          <i class="fas fa-sliders-h"></i>
          <span>کنترل‌های اصلی</span>
        </div>

        <div style="margin-bottom: 16px">
          <div class="seg">
            <div class="hold-menu" id="waveHold">
              <button id="waveBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false"><i class="fas fa-wave-square"></i> نوع موج: <span id="waveName">modified square</span></button>
              <div class="menu-panel" id="waveMenu" aria-hidden="true" role="menu">
                <button data-wave="sine" role="menuitem">
                  <span>sine — سینوسی</span>
                  <span class="wave-icon"><i class="fas fa-wave-sine"></i></span>
                </button>
                <button data-wave="square" role="menuitem">
                  <span>square — مربع</span>
                  <span class="wave-icon"><i class="fas fa-wave-square"></i></span>
                </button>
                <button data-wave="modified_square" role="menuitem">
                  <span>modified square — مربع اصلاح شده</span>
                  <span class="wave-icon"><i class="fas fa-square"></i></span>
                </button>
                <button data-wave="triangle" role="menuitem">
                  <span>triangle — مثلثی</span>
                  <span class="wave-icon"><i class="fas fa-play"></i></span>
                </button>
                <button data-wave="sawtooth" role="menuitem">
                  <span>sawtooth — دندان‌اره</span>
                  <span class="wave-icon"><i class="fas fa-teeth"></i></span>
                </button>
                <button data-wave="noise" role="menuitem">
                  <span>noise — نویز سفید</span>
                  <span class="wave-icon"><i class="fas fa-water"></i></span>
                </button>
                <button data-wave="pink_noise" role="menuitem">
                  <span>pink noise — نویز صورتی</span>
                  <span class="wave-icon"><i class="fas fa-water"></i></span>
                </button>
                <button data-wave="brown_noise" role="menuitem">
                  <span>brown noise — نویز قهوه‌ای</span>
                  <span class="wave-icon"><i class="fas fa-water"></i></span>
                </button>
              </div>
            </div>
            <button id="advBtn" class="icon-btn"><i class="fas fa-cogs"></i> کنترل حرفه‌ای</button>
          </div>
        </div>
        
        <label><i class="fas fa-waveform"></i> فرکانس (Hz)</label>
        <div class="control">
          <div class="num-box">
            <button class="small-btn" id="freqDec"><i class="fas fa-minus"></i></button>
            <input id="frequency" class="value-input" type="number" value="50" min="0.5" max="100" step="1">
            <button class="small-btn" id="freqInc"><i class="fas fa-plus"></i></button>
          </div>
          <div class="muted">Hz</div>
        </div>
        <label><i class="fas fa-volume-up"></i> ولوم (٪)</label>
        <div class="control">
          <div class="num-box">
            <button class="small-btn" id="volDec"><i class="fas fa-minus"></i></button>
            <input id="volume" class="value-input" type="number" value="50" min="0" max="100" step="1">
            <button class="small-btn" id="volInc"><i class="fas fa-plus"></i></button>
          </div>
          <div class="muted">٪</div>
        </div>
        <label><i class="fas fa-clock"></i> مدت زمان ذخیره (ثانیه) — حداکثر 300</label>
        <div class="control">
          <div class="num-box">
            <button class="small-btn" id="durDec"><i class="fas fa-minus"></i></button>
            <input id="duration" class="value-input" type="number" value="300" min="1" max="300" step="1">
            <button class="small-btn" id="durInc"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div id="errorContainer"></div>
        <div class="footer-note"></div>
      </div>
      <div class="col" style="flex:2;">
        <div class="label-row">
          <label><i class="fas fa-chart-area"></i> نمایش شکل موج — فرکانس: <span id="currentFreqDisplay">50</span> Hz</label>
          <span id="waveStatus" class="status-indicator status-stopped"><i class="fas fa-pause"></i> متوقف</span>
        </div>
        <canvas id="waveCanvas"></canvas>
        <div class="play-controls">
          <button id="playBtn" class="play-btn" aria-label="پخش صدا و نمایش موج"><i class="fas fa-play"></i> پخش صدا و موج</button>
          <button id="stopBtn" class="stop-btn" aria-label="توقف صدا و موج"><i class="fas fa-stop"></i> توقف</button>
          <button id="saveBtn" class="save-btn" aria-label="ذخیره فایل صوتی"><i class="fas fa-save"></i> ذخیره WAV</button>
          <div style="flex:1"></div>
          <div class="muted"><span id="sampleRateText"></span></div>
        </div>
        <div id="proPanel" class="pro-section" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="section-title">
              <i class="fas fa-tools"></i>
              <span>کنترل حرفه‌ای</span>
            </div>
            <button id="proClose" class="small-btn"><i class="fas fa-times"></i> بستن</button>
          </div>
          
          <div class="pause-controls">
            <label>
              <input type="checkbox" id="pauseToggle">
              <i class="fas fa-pause-circle"></i> فعال کردن وقفه بین پالس‌ها
            </label>
            <div id="pauseSettings" style="margin-top: 16px; display: none;">
              <label>مدت زمان وقفه (ثانیه)</label>
              <div class="control">
                <div class="num-box">
                  <button class="small-btn" id="pauseDec"><i class="fas fa-minus"></i></button>
                  <input id="pauseDuration" class="value-input" type="number" value="3" min="1" max="10" step="1">
                  <button class="small-btn" id="pauseInc"><i class="fas fa-plus"></i></button>
                </div>
                <div class="muted">ثانیه</div>
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px">
            <label><i class="fas fa-sliders-h"></i> نسبت T_on : T_off — مجموع ثابت = 10</label>
            <div class="control" style="align-items:center">
              <div class="num-box">
                <button class="small-btn" id="tOnDec"><i class="fas fa-minus"></i></button>
                <input id="tOn" class="value-input" type="number" value="5" min="0" max="10" step="1">
                <button class="small-btn" id="tOnInc"><i class="fas fa-plus"></i></button>
              </div>
              <div style="width:12px;text-align:center">:</div>
              <div class="num-box">
                <button class="small-btn" id="tOffDec"><i class="fas fa-minus"></i></button>
                <input id="tOff" class="value-input" type="number" value="5" min="0" max="10" step="1">
                <button class="small-btn" id="tOffInc"><i class="fas fa-plus"></i></button>
              </div>
              <div style="margin-left:12px" class="muted">جمع ثابت = 10</div>
            </div>
            <div class="ton-toff-info" id="tonToffInfo">
              زمان روشن: 2.5 ثانیه | زمان خاموش: 2.5 ثانیه
            </div>
          </div>
          
          <div class="sweep-controls">
            <label>
              <input type="checkbox" id="sweepToggle">
              <i class="fas fa-chart-line"></i> فعال کردن Sweep (تغییر فرکانس)
            </label>
            <div id="sweepSettings" style="margin-top: 16px; display: none;">
              <label>فرکانس شروع (Hz)</label>
              <div class="control">
                <div class="num-box">
                  <button class="small-btn" id="sweepStartDec"><i class="fas fa-minus"></i></button>
                  <input id="sweepStart" class="value-input" type="number" value="0.5" min="0.5" max="100" step="1">
                  <button class="small-btn" id="sweepStartInc"><i class="fas fa-plus"></i></button>
                </div>
                <div class="muted">Hz</div>
              </div>
              <label>فرکانس پایان (Hz)</label>
              <div class="control">
                <div class="num-box">
                  <button class="small-btn" id="sweepEndDec"><i class="fas fa-minus"></i></button>
                  <input id="sweepEnd" class="value-input" type="number" value="100" min="0.5" max="100" step="1">
                  <button class="small-btn" id="sweepEndInc"><i class="fas fa-plus"></i></button>
                </div>
                <div class="muted">Hz</div>
              </div>
              <label>مدت زمان Sweep (ثانیه)</label>
              <div class="control">
                <div class="num-box">
                  <button class="small-btn" id="sweepDurationDec"><i class="fas fa-minus"></i></button>
                  <input id="sweepDuration" class="value-input" type="number" value="5" min="0.1" max="60" step="1">
                  <button class="small-btn" id="sweepDurationInc"><i class="fas fa-plus"></i></button>
                </div>
                <div class="muted">ثانیه</div>
              </div>
              <label>
                <input type="checkbox" id="sweepLoopToggle">
                <i class="fas fa-redo"></i> تکرار Sweep (Loop)
              </label>
              <div class="footer-note">در حالت Sweep، فرکانس به صورت خطی از مقدار شروع به مقدار پایان تغییر می‌کند.</div>
            </div>
          </div>
          
          <div class="sweep-controls">
            <label>
              <input type="checkbox" id="randomToggle">
              <i class="fas fa-random"></i> فعال کردن تغییر رندوم شدت و فرکانس
            </label>
            <div id="randomSettings" style="margin-top: 16px; display: none;">
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px;">انتخاب نوع تغییرات رندوم:</label>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="randomFreqToggle" checked>
                    <span>فرکانس رندوم</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="randomVolToggle" checked>
                    <span>شدت صدا رندوم</span>
                  </label>
                </div>
              </div>
              
              <label>محدوده فرکانس (Hz)</label>
              <div class="control">
                <div class="num-box">
                  <input id="randomFreqMin" class="value-input" type="number" value="0.5" min="0.5" max="100" step="1" placeholder="حداقل">
                </div>
                <div class="muted">تا</div>
                <div class="num-box">
                  <input id="randomFreqMax" class="value-input" type="number" value="100" min="0.5" max="100" step="1" placeholder="حداکثر">
                </div>
                <div class="muted">Hz</div>
              </div>
              <label>محدوده شدت صدا (%)</label>
              <div class="control">
                <div class="num-box">
                  <input id="randomVolMin" class="value-input" type="number" value="20" min="0" max="100" step="1" placeholder="حداقل">
                </div>
                <div class="muted">تا</div>
                <div class="num-box">
                  <input id="randomVolMax" class="value-input" type="number" value="80" min="0" max="100" step="1" placeholder="حداکثر">
                </div>
                <div class="muted">%</div>
              </div>
              <label>سرعت تغییر (ثانیه)</label>
              <div class="control">
                <div class="num-box">
                  <button class="small-btn" id="randomSpeedDec"><i class="fas fa-minus"></i></button>
                  <input id="randomSpeed" class="value-input" type="number" value="2" min="0.5" max="10" step="1">
                  <button class="small-btn" id="randomSpeedInc"><i class="fas fa-plus"></i></button>
                </div>
                <div class="muted">ثانیه</div>
              </div>
              
              <div class="footer-note">در این حالت، فرکانس و شدت صدا به صورت رندوم در محدوده مشخص شده تغییر می‌کند تا از عادی شدن سیگنال برای بیمار جلوگیری شود.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>© 2025 تمامی حقوق محفوظ است | طراحی و توسعه توسط <strong>تینا کریمی فرد</strong></p>
      <p>
        <a href="mailto:karimifard.tina@gmail.com" class="footer-email">
          <i class="fas fa-envelope"></i> karimifard.tina@gmail.com
        </a>
      </p>
    </div>
  </div>

  <script>
    /* ---------- state ---------- */
    let waveType = 'modified_square';
    const sampleRate = 44100;
    document.getElementById('sampleRateText').textContent = sampleRate + ' Hz';
    let animationId = null;
    let animationTime = 0;
    let lastAnimationTime = 0;
    let isPlaying = false;
    let sweepEnabled = false;
    let pauseEnabled = false;
    let sweepLoopEnabled = false;
    let drawTimeout = null;
    let randomEnabled = false;
    let randomInterval = null;
    let lastRandomChange = 0;
    let randomFreqEnabled = true;
    let randomVolEnabled = true;
    
    // متغیرهای جدید برای ذخیره مقادیر رندوم فعلی
    let currentRandomFreq = 50;
    let currentRandomVol = 50;
    
    // متغیرهای جدید برای تولید صدا به صورت real-time
    let audioCtx = null;
    let oscillator = null;
    let gainNode = null;
    let isAudioPlaying = false;
    let audioStartTime = 0;
    
    // متغیرهای جدید برای Sweep
    let sweepStartTime = 0;
    let isSweepPlaying = false;
    let sweepInterval = null;
    let currentSweepFreq = 0;
    let sweepProgress = 0;
    
    // برای نویز صورتی و قهوه‌ای
    let pinkNoiseBuffer = null;
    let brownNoiseBuffer = null;
    let noiseSource = null;

    // متغیرهای جدید برای کنترل وقفه
    let pauseInterval = null;
    let isPauseActive = false;
    let pauseStartTime = 0;

    /* ---------- DOM refs ---------- */
    const waveBtn = document.getElementById('waveBtn');
    const waveMenu = document.getElementById('waveMenu');
    const waveNameSpan = document.getElementById('waveName');
    const advBtn = document.getElementById('advBtn');
    const proPanel = document.getElementById('proPanel');
    const proClose = document.getElementById('proClose');
    const frequencyInput = document.getElementById('frequency');
    const volumeInput = document.getElementById('volume');
    const durationInput = document.getElementById('duration');
    const freqInc = document.getElementById('freqInc'), freqDec = document.getElementById('freqDec');
    const volInc = document.getElementById('volInc'), volDec = document.getElementById('volDec');
    const durInc = document.getElementById('durInc'), durDec = document.getElementById('durDec');
    const tOn = document.getElementById('tOn'), tOff = document.getElementById('tOff');
    const tOnInc = document.getElementById('tOnInc'), tOnDec = document.getElementById('tOnDec');
    const tOffInc = document.getElementById('tOffInc'), tOffDec = document.getElementById('tOffDec');
    const tonToffInfo = document.getElementById('tonToffInfo');
    const currentFreqDisplay = document.getElementById('currentFreqDisplay');
    const canvas = document.getElementById('waveCanvas');
    const ctx = canvas.getContext('2d');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const saveBtn = document.getElementById('saveBtn');
    const waveStatus = document.getElementById('waveStatus');
    const errorContainer = document.getElementById('errorContainer');
    
    // Pause controls
    const pauseToggle = document.getElementById('pauseToggle');
    const pauseSettings = document.getElementById('pauseSettings');
    const pauseDuration = document.getElementById('pauseDuration');
    const pauseInc = document.getElementById('pauseInc');
    const pauseDec = document.getElementById('pauseDec');
    
    // Sweep controls
    const sweepToggle = document.getElementById('sweepToggle');
    const sweepSettings = document.getElementById('sweepSettings');
    const sweepStart = document.getElementById('sweepStart');
    const sweepEnd = document.getElementById('sweepEnd');
    const sweepStartInc = document.getElementById('sweepStartInc');
    const sweepStartDec = document.getElementById('sweepStartDec');
    const sweepEndInc = document.getElementById('sweepEndInc');
    const sweepEndDec = document.getElementById('sweepEndDec');
    const sweepDuration = document.getElementById('sweepDuration');
    const sweepDurationInc = document.getElementById('sweepDurationInc');
    const sweepDurationDec = document.getElementById('sweepDurationDec');
    const sweepLoopToggle = document.getElementById('sweepLoopToggle');
    
    // Random controls
    const randomToggle = document.getElementById('randomToggle');
    const randomSettings = document.getElementById('randomSettings');
    const randomFreqToggle = document.getElementById('randomFreqToggle');
    const randomVolToggle = document.getElementById('randomVolToggle');
    const randomFreqMin = document.getElementById('randomFreqMin');
    const randomFreqMax = document.getElementById('randomFreqMax');
    const randomVolMin = document.getElementById('randomVolMin');
    const randomVolMax = document.getElementById('randomVolMax');
    const randomSpeed = document.getElementById('randomSpeed');
    const randomSpeedInc = document.getElementById('randomSpeedInc');
    const randomSpeedDec = document.getElementById('randomSpeedDec');

    // Theme refs
    const themeListEl = document.getElementById('themeList');

    /* ---------- Utility Functions ---------- */
    function showError(message) {
        errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
        setTimeout(() => {
            errorContainer.innerHTML = '';
        }, 5000);
    }

    function safeIncrement(input, min, max, step) {
        let value = parseFloat(input.value) || min;
        value = Math.min(max, value + step);
        value = Math.max(min, value);
        input.value = value;
        if (input === frequencyInput) {
            currentFreqDisplay.textContent = value;
        }
        scheduleRedraw();
    }

    function scheduleRedraw() {
        clearTimeout(drawTimeout);
        drawTimeout = setTimeout(drawStaticPreview, 50);
    }

    /* ---------- UI behavior ---------- */
    // wave menu
    waveBtn.addEventListener('click', ()=> {
        const isExpanded = waveMenu.classList.toggle('show');
        waveMenu.setAttribute('aria-hidden', !isExpanded);
        waveBtn.setAttribute('aria-expanded', isExpanded);
    });

    document.addEventListener('click', (ev)=> {
        if(!waveBtn.contains(ev.target) && !waveMenu.contains(ev.target)){
            waveMenu.classList.remove('show');
            waveMenu.setAttribute('aria-hidden', 'true');
            waveBtn.setAttribute('aria-expanded', 'false');
        }
    });

    function updateWaveButton() {
        const waveNames = {
            'sine': 'sine',
            'square': 'square', 
            'modified_square': 'modified square',
            'triangle': 'triangle',
            'sawtooth': 'sawtooth',
            'noise': 'noise',
            'pink_noise': 'pink noise',
            'brown_noise': 'brown noise'
        };
        
        waveBtn.innerHTML = `<i class="fas fa-wave-square"></i> نوع موج: <span id="waveName">${waveNames[waveType]}</span>`;
        
        if (waveType) {
            waveBtn.classList.add('wave-btn-active');
        } else {
            waveBtn.classList.remove('wave-btn-active');
        }
    }

    waveMenu.querySelectorAll('button[data-wave]').forEach(b=>{
        b.addEventListener('click', ()=> {
            waveType = b.dataset.wave;
            updateWaveButton();
            
            waveMenu.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
            
            waveMenu.classList.remove('show');
            waveMenu.setAttribute('aria-hidden', 'true');
            waveBtn.setAttribute('aria-expanded', 'false');
            drawStaticPreview();
        });
    });

    // مقداردهی اولیه
    updateWaveButton();
    waveMenu.querySelector('button[data-wave="'+waveType+'"]').classList.add('active');

    // Pause toggle
    pauseToggle.addEventListener('change', function() {
        pauseEnabled = this.checked;
        pauseSettings.style.display = pauseEnabled ? 'block' : 'none';
        updateTonToffInfo();
        drawStaticPreview();
    });

    // Pause controls
    pauseInc.addEventListener('click', ()=> safeIncrement(pauseDuration, 1, 10, 1));
    pauseDec.addEventListener('click', ()=> safeIncrement(pauseDuration, 1, 10, -1));
    pauseDuration.addEventListener('input', () => {
        updateTonToffInfo();
        scheduleRedraw();
    });

    // Sweep toggle
    sweepToggle.addEventListener('change', function() {
        sweepEnabled = this.checked;
        sweepSettings.style.display = sweepEnabled ? 'block' : 'none';
        if (sweepEnabled) {
            randomToggle.checked = false;
            randomEnabled = false;
            randomSettings.style.display = 'none';
            stopRandomChanges();
        }
        drawStaticPreview();
    });

    // Sweep loop toggle
    sweepLoopToggle.addEventListener('change', function() {
        sweepLoopEnabled = this.checked;
        drawStaticPreview();
    });

    // Random toggle
    randomToggle.addEventListener('change', function() {
        randomEnabled = this.checked;
        randomSettings.style.display = randomEnabled ? 'block' : 'none';
        if (randomEnabled) {
            sweepToggle.checked = false;
            sweepEnabled = false;
            sweepSettings.style.display = 'none';
            startRandomChanges();
        } else {
            stopRandomChanges();
        }
        drawStaticPreview();
    });

    // Random frequency toggle
    randomFreqToggle.addEventListener('change', function() {
        randomFreqEnabled = this.checked;
        drawStaticPreview();
    });

    // Random volume toggle
    randomVolToggle.addEventListener('change', function() {
        randomVolEnabled = this.checked;
        drawStaticPreview();
    });

    // Sweep controls
    sweepStartInc.addEventListener('click', ()=> safeIncrement(sweepStart, 0.5, 100, 1));
    sweepStartDec.addEventListener('click', ()=> safeIncrement(sweepStart, 0.5, 100, -1));
    sweepEndInc.addEventListener('click', ()=> safeIncrement(sweepEnd, 0.5, 100, 1));
    sweepEndDec.addEventListener('click', ()=> safeIncrement(sweepEnd, 0.5, 100, -1));
    sweepDurationInc.addEventListener('click', ()=> safeIncrement(sweepDuration, 0.1, 60, 1));
    sweepDurationDec.addEventListener('click', ()=> safeIncrement(sweepDuration, 0.1, 60, -1));

    sweepStart.addEventListener('input', scheduleRedraw);
    sweepEnd.addEventListener('input', scheduleRedraw);
    sweepDuration.addEventListener('input', scheduleRedraw);

    // Random controls
    randomSpeedInc.addEventListener('click', ()=> safeIncrement(randomSpeed, 0.5, 10, 1));
    randomSpeedDec.addEventListener('click', ()=> safeIncrement(randomSpeed, 0.5, 10, -1));

    // pro panel
    advBtn.addEventListener('click', ()=> {
        proPanel.style.display = (proPanel.style.display==='block')?'none':'block';
    });

    proClose.addEventListener('click', ()=> proPanel.style.display = 'none');

    // plus/minus
    freqInc.addEventListener('click', ()=> safeIncrement(frequencyInput, 0.5, 100, 1));
    freqDec.addEventListener('click', ()=> safeIncrement(frequencyInput, 0.5, 100, -1));
    volInc.addEventListener('click', ()=> safeIncrement(volumeInput, 0, 100, 1));
    volDec.addEventListener('click', ()=> safeIncrement(volumeInput, 0, 100, -1));
    durInc.addEventListener('click', ()=> safeIncrement(durationInput, 1, 300, 1));
    durDec.addEventListener('click', ()=> safeIncrement(durationInput, 1, 300, -1));

    frequencyInput.addEventListener('input', function() {
        currentFreqDisplay.textContent = this.value;
        scheduleRedraw();
    });
    volumeInput.addEventListener('input', scheduleRedraw);

    // T_on/T_off
    const TOTAL = 10;
    
    function updateTonToffInfo() {
        const tOnVal = +tOn.value || 5;
        const tOffVal = +tOff.value || 5;
        const pauseVal = pauseEnabled ? (+pauseDuration.value || 3) : 0;
        
        const totalTime = pauseVal;
        const onTime = (tOnVal / TOTAL) * totalTime;
        const offTime = (tOffVal / TOTAL) * totalTime;
        
        if (pauseEnabled) {
            tonToffInfo.textContent = `زمان روشن: ${onTime.toFixed(1)} ثانیه | زمان خاموش: ${offTime.toFixed(1)} ثانیه`;
        } else {
            tonToffInfo.textContent = `بدون وقفه - موج پیوسته`;
        }
    }

    function setTValues(newOn){
        newOn = Math.max(0, Math.min(TOTAL, Math.round(newOn)));
        const newOff = TOTAL - newOn;
        tOn.value = newOn;
        tOff.value = newOff;
        updateTonToffInfo();
        drawStaticPreview();
    }

    tOn.addEventListener('input', ()=> setTValues(+tOn.value||0));
    tOff.addEventListener('input', ()=> setTValues(TOTAL-(+tOff.value||0)));
    tOnInc.addEventListener('click', ()=> setTValues(+tOn.value+1));
    tOnDec.addEventListener('click', ()=> setTValues(+tOn.value-1));
    tOffInc.addEventListener('click', ()=> setTValues(+tOn.value-1));
    tOffDec.addEventListener('click', ()=> setTValues(+tOn.value+1));

    setTValues(5);

    /* ---------- Canvas ---------- */
    function fixCanvasSize(){
        const ratio=window.devicePixelRatio||1;
        const cssW=canvas.clientWidth||800;
        const cssH=canvas.clientHeight||280;
        canvas.width=Math.floor(cssW*ratio);
        canvas.height=Math.floor(cssH*ratio);
        ctx.setTransform(ratio,0,0,ratio,0,0);
        drawStaticPreview();
    }

    window.addEventListener('resize', fixCanvasSize);

    /* ---------- Wave Generation Functions ---------- */
    function generateModifiedSquare(phase, freqCustomVal) {
        const modifiedPhase = (phase * freqCustomVal * 0.1) % 1;
        
        if (modifiedPhase < 0.45) {
            return 1;
        } else if (modifiedPhase < 0.5) {
            const transition = (modifiedPhase - 0.45) / 0.05;
            return 1 - (transition * 2);
        } else if (modifiedPhase < 0.95) {
            return -1;
        } else {
            const transition = (modifiedPhase - 0.95) / 0.05;
            return -1 + (transition * 2);
        }
    }

    // تولید نویز صورتی
    function generatePinkNoise() {
        if (!pinkNoiseBuffer) {
            const bufferSize = sampleRate * 2;
            pinkNoiseBuffer = new Float32Array(bufferSize);
            
            let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
            
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                
                const pink = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                b6 = white * 0.115926;
                
                pinkNoiseBuffer[i] = pink * 0.11;
            }
        }
        return pinkNoiseBuffer;
    }

    // تولید نویز قهوه‌ای
    function generateBrownNoise() {
        if (!brownNoiseBuffer) {
            const bufferSize = sampleRate * 2;
            brownNoiseBuffer = new Float32Array(bufferSize);
            
            let lastOut = 0;
            
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                brownNoiseBuffer[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = brownNoiseBuffer[i];
                brownNoiseBuffer[i] *= 3.5;
            }
        }
        return brownNoiseBuffer;
    }

    function generateWaveSample(phase, type) {
        let sample = 0;
        
        switch(type) {
            case 'sine':
                sample = Math.sin(phase * 2 * Math.PI);
                break;
            case 'square':
                sample = (phase % 1) < 0.5 ? 1 : -1;
                break;
            case 'modified_square':
                sample = generateModifiedSquare(phase, 5);
                break;
            case 'triangle':
                sample = 4 * Math.abs((phase % 1) - 0.5) - 1;
                break;
            case 'sawtooth':
                sample = 2 * (phase % 1) - 1;
                break;
            case 'noise':
                sample = Math.random() * 2 - 1;
                break;
            case 'pink_noise':
                const pinkBuffer = generatePinkNoise();
                const pinkIndex = Math.floor((phase * sampleRate) % pinkBuffer.length);
                sample = pinkBuffer[pinkIndex];
                break;
            case 'brown_noise':
                const brownBuffer = generateBrownNoise();
                const brownIndex = Math.floor((phase * sampleRate) % brownBuffer.length);
                sample = brownBuffer[brownIndex];
                break;
            default:
                sample = Math.sin(phase * 2 * Math.PI);
        }
        
        return sample;
    }

    /* ---------- WAV File Generation ---------- */
    function generateWavFile() {
        const duration = +durationInput.value || 300;
        const vol = +volumeInput.value || 50;
        const type = waveType;
        
        // محاسبه تعداد نمونه‌ها
        const numSamples = Math.floor(duration * sampleRate);
        
        // ایجاد آرایه برای داده‌های صوتی
        const audioData = new Float32Array(numSamples);
        
        // تنظیمات رندوم
        const randomSpeedVal = +randomSpeed.value || 2;
        const randomFreqMinVal = Math.max(0.5, +randomFreqMin.value || 0.5);
        const randomFreqMaxVal = Math.max(randomFreqMinVal, +randomFreqMax.value || 100);
        const randomVolMinVal = Math.max(0, +randomVolMin.value || 20);
        const randomVolMaxVal = Math.min(100, Math.max(randomVolMinVal, +randomVolMax.value || 80));
        
        // متغیرهای برای شبیه‌سازی تغییرات رندوم
        let currentFreq = randomFreqEnabled ? (Math.random() * (randomFreqMaxVal - randomFreqMinVal) + randomFreqMinVal) : (+frequencyInput.value || 50);
        let currentVol = randomVolEnabled ? (Math.random() * (randomVolMaxVal - randomVolMinVal) + randomVolMinVal) : vol;
        let lastChangeTime = 0;
        
        // تولید نمونه‌های صوتی
        for (let i = 0; i < numSamples; i++) {
            const time = i / sampleRate;
            
            // شبیه‌سازی تغییرات رندوم
            if (randomEnabled && time - lastChangeTime >= randomSpeedVal) {
                if (randomFreqEnabled) {
                    currentFreq = Math.random() * (randomFreqMaxVal - randomFreqMinVal) + randomFreqMinVal;
                }
                if (randomVolEnabled) {
                    currentVol = Math.random() * (randomVolMaxVal - randomVolMinVal) + randomVolMinVal;
                }
                lastChangeTime = time;
            }
            
            // محاسبه فرکانس فعلی
            let finalFreq = currentFreq;
            if (sweepEnabled) {
                const sweepStartVal = +sweepStart.value || 0.5;
                const sweepEndVal = +sweepEnd.value || 100;
                const sweepDurationVal = +sweepDuration.value || 5;
                
                // محاسبه فرکانس بر اساس زمان در حالت sweep
                let progress;
                if (sweepLoopEnabled) {
                    progress = (time % sweepDurationVal) / sweepDurationVal;
                } else {
                    progress = Math.min(time / sweepDurationVal, 1);
                }
                finalFreq = sweepStartVal + (sweepEndVal - sweepStartVal) * progress;
            } else if (!randomEnabled || !randomFreqEnabled) {
                finalFreq = +frequencyInput.value || 50;
            }
            
            // اعمال تنظیمات T_on/T_off در صورت فعال بودن
            let isOn = true;
            if (pauseEnabled) {
                const tOnVal = +tOn.value || 5;
                const tOffVal = +tOff.value || 5;
                const pauseVal = +pauseDuration.value || 3;
                
                const totalTime = pauseVal;
                const onDuration = (tOnVal / TOTAL) * totalTime;
                const offDuration = (tOffVal / TOTAL) * totalTime;
                const cycleDuration = onDuration + offDuration;
                
                const timeInCycle = time % cycleDuration;
                isOn = timeInCycle < onDuration;
            }
            
            let sample = 0;
            if (isOn) {
                const phase = time * finalFreq;
                sample = generateWaveSample(phase, type);
            }
            
            // اعمال ولوم نهایی
            let finalVol;
            if (randomEnabled && randomVolEnabled) {
                finalVol = currentVol;
            } else {
                finalVol = vol;
            }
            
            audioData[i] = sample * (finalVol / 100);
        }
        
        // تبدیل Float32Array به Int16Array برای WAV
        const wavData = new Int16Array(numSamples);
        for (let i = 0; i < numSamples; i++) {
            wavData[i] = Math.max(-32768, Math.min(32767, audioData[i] * 32767));
        }
        
        // ایجاد فایل WAV
        const wavBuffer = createWavBuffer(wavData, sampleRate);
        
        // ایجاد نام فایل
        let filename = `wave_${type}`;
        if (sweepEnabled) {
            filename += `_sweep_${+sweepStart.value}Hz_to_${+sweepEnd.value}Hz`;
        } else if (randomEnabled && randomFreqEnabled) {
            filename += `_randomFreq_${randomFreqMinVal}Hz_${randomFreqMaxVal}Hz`;
        } else {
            filename += `_${+frequencyInput.value}Hz`;
        }
        
        if (randomEnabled && randomVolEnabled) {
            filename += `_randomVol_${randomVolMinVal}_${randomVolMaxVal}`;
        } else {
            filename += `_${vol}vol`;
        }
        
        filename += `_${duration}s.wav`;
        
        // دانلود فایل
        downloadWavFile(wavBuffer, filename);
    }

    function createWavBuffer(audioData, sampleRate) {
        const buffer = new ArrayBuffer(44 + audioData.length * 2);
        const view = new DataView(buffer);
        
        // نوشتن هدر WAV
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + audioData.length * 2, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true); // PCM format
        view.setUint16(22, 1, true); // mono
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true); // byte rate
        view.setUint16(32, 2, true); // block align
        view.setUint16(34, 16, true); // bits per sample
        writeString(view, 36, 'data');
        view.setUint32(40, audioData.length * 2, true);
        
        // نوشتن داده‌های صوتی
        let offset = 44;
        for (let i = 0; i < audioData.length; i++) {
            view.setInt16(offset, audioData[i], true);
            offset += 2;
        }
        
        return buffer;
    }

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    function downloadWavFile(buffer, filename) {
        const blob = new Blob([buffer], { type: 'audio/wav' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }

    /* ---------- Random Changes Functions ---------- */
    function generateRandomValue(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function applyRandomChanges() {
        if (!randomEnabled || !isPlaying) return;
        
        const currentTime = Date.now();
        if (currentTime - lastRandomChange < (+randomSpeed.value || 2) * 1000) {
            return;
        }
        
        lastRandomChange = currentTime;
        
        // تغییر فرکانس به صورت رندوم (فقط اگر فعال باشد)
        if (randomFreqEnabled) {
            const freqMin = Math.max(0.5, +randomFreqMin.value || 0.5);
            const freqMax = Math.max(freqMin, +randomFreqMax.value || 100);
            currentRandomFreq = generateRandomValue(freqMin, freqMax);
            frequencyInput.value = currentRandomFreq;
            currentFreqDisplay.textContent = currentRandomFreq;
            
            // به‌روزرسانی فرکانس صدا در صورت پخش
            if (isAudioPlaying && oscillator && waveType !== 'noise' && waveType !== 'pink_noise' && waveType !== 'brown_noise') {
                oscillator.frequency.setValueAtTime(currentRandomFreq, audioCtx.currentTime);
            }
        }
        
        // تغییر شدت صدا به صورت رندوم (فقط اگر فعال باشد)
        if (randomVolEnabled) {
            const volMin = Math.max(0, +randomVolMin.value || 20);
            const volMax = Math.min(100, Math.max(volMin, +randomVolMax.value || 80));
            currentRandomVol = generateRandomValue(volMin, volMax);
            volumeInput.value = currentRandomVol;
            
            // به‌روزرسانی ولوم صدا در صورت پخش
            if (isAudioPlaying && gainNode) {
                const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
                gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
            }
        }
        
        drawStaticPreview();
    }

    function startRandomChanges() {
        if (randomInterval) {
            clearInterval(randomInterval);
        }
        
        // مقداردهی اولیه مقادیر رندوم
        if (randomFreqEnabled) {
            const freqMin = Math.max(0.5, +randomFreqMin.value || 0.5);
            const freqMax = Math.max(freqMin, +randomFreqMax.value || 100);
            currentRandomFreq = generateRandomValue(freqMin, freqMax);
            frequencyInput.value = currentRandomFreq;
            currentFreqDisplay.textContent = currentRandomFreq;
            
            // به‌روزرسانی فرکانس صدا در صورت پخش
            if (isAudioPlaying && oscillator && waveType !== 'noise' && waveType !== 'pink_noise' && waveType !== 'brown_noise') {
                oscillator.frequency.setValueAtTime(currentRandomFreq, audioCtx.currentTime);
            }
        }
        
        if (randomVolEnabled) {
            const volMin = Math.max(0, +randomVolMin.value || 20);
            const volMax = Math.min(100, Math.max(volMin, +randomVolMax.value || 80));
            currentRandomVol = generateRandomValue(volMin, volMax);
            volumeInput.value = currentRandomVol;
            
            // به‌روزرسانی ولوم صدا در صورت پخش
            if (isAudioPlaying && gainNode) {
                const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
                gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
            }
        }
        
        // اجرای تغییرات رندوم با سرعت مشخص
        randomInterval = setInterval(applyRandomChanges, 100);
        lastRandomChange = Date.now();
    }

    function stopRandomChanges() {
        if (randomInterval) {
            clearInterval(randomInterval);
            randomInterval = null;
        }
    }

    /* ---------- Sweep Functions ---------- */
    function updateSweepFrequency() {
        if (!sweepEnabled || !isAudioPlaying || !oscillator) return;
        
        const sweepStartVal = +sweepStart.value || 0.5;
        const sweepEndVal = +sweepEnd.value || 100;
        const sweepDurationVal = +sweepDuration.value || 5;
        
        const currentTime = audioCtx.currentTime;
        const elapsedTime = currentTime - sweepStartTime;
        
        if (elapsedTime > sweepDurationVal && !sweepLoopEnabled) {
            // در حالت غیرتکرار، فرکانس در پایان ثابت می‌ماند
            currentSweepFreq = sweepEndVal;
            oscillator.frequency.setValueAtTime(sweepEndVal, currentTime);
            return;
        }
        
        // محاسبه فرکانس فعلی بر اساس زمان سپری شده
        let progress;
        if (sweepLoopEnabled) {
            progress = (elapsedTime % sweepDurationVal) / sweepDurationVal;
        } else {
            progress = Math.min(elapsedTime / sweepDurationVal, 1);
        }
        
        // محاسبه فرکانس فعلی (تغییر خطی)
        currentSweepFreq = sweepStartVal + (sweepEndVal - sweepStartVal) * progress;
        sweepProgress = progress;
        
        // تنظیم فرکانس صدا
        oscillator.frequency.setValueAtTime(currentSweepFreq, currentTime);
        
        // به‌روزرسانی نمایش فرکانس
        currentFreqDisplay.textContent = currentSweepFreq.toFixed(1);
        
        // به‌روزرسانی انیمیشن
        drawStaticPreview();
    }

    function startSweep() {
        if (!sweepEnabled || !isAudioPlaying || !oscillator) return;
        
        const sweepStartVal = +sweepStart.value || 0.5;
        const sweepEndVal = +sweepEnd.value || 100;
        const sweepDurationVal = +sweepDuration.value || 5;
        
        sweepStartTime = audioCtx.currentTime;
        isSweepPlaying = true;
        currentSweepFreq = sweepStartVal;
        sweepProgress = 0;
        
        // تنظیم فرکانس اولیه
        oscillator.frequency.setValueAtTime(sweepStartVal, sweepStartTime);
        
        // اجرای Sweep
        if (sweepInterval) {
            clearInterval(sweepInterval);
        }
        sweepInterval = setInterval(updateSweepFrequency, 50); // به‌روزرسانی هر 50 میلی‌ثانیه
    }

    function stopSweep() {
        if (sweepInterval) {
            clearInterval(sweepInterval);
            sweepInterval = null;
        }
        isSweepPlaying = false;
        sweepProgress = 0;
    }

    /* ---------- Pause Control Functions ---------- */
    function startPauseControl() {
        if (!pauseEnabled || !isAudioPlaying) return;
        
        const tOnVal = +tOn.value || 5;
        const tOffVal = +tOff.value || 5;
        const pauseVal = +pauseDuration.value || 3;
        
        const totalTime = pauseVal;
        const onTime = (tOnVal / 10) * totalTime;
        const offTime = (tOffVal / 10) * totalTime;
        const cycleTime = onTime + offTime;
        
        pauseStartTime = audioCtx.currentTime;
        isPauseActive = true;
        
        // اجرای اولین سیکل
        executePauseCycle(onTime, offTime, cycleTime);
    }

    function executePauseCycle(onTime, offTime, cycleTime) {
        if (!isAudioPlaying || !pauseEnabled) return;
        
        const currentTime = audioCtx.currentTime;
        const elapsedTime = currentTime - pauseStartTime;
        const timeInCycle = elapsedTime % cycleTime;
        
        if (timeInCycle < onTime) {
            // حالت روشن - صدا پخش شود
            if (gainNode) {
                const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
                gainNode.gain.setValueAtTime(vol, currentTime);
            }
            
            // شروع Sweep در صورت فعال بودن
            if (sweepEnabled && oscillator && waveType !== 'noise' && waveType !== 'pink_noise' && waveType !== 'brown_noise' && !isSweepPlaying) {
                startSweep();
            }
        } else {
            // حالت خاموش - صدا قطع شود
            if (gainNode) {
                gainNode.gain.setValueAtTime(0, currentTime);
            }
            
            // توقف Sweep در صورت فعال بودن
            if (sweepEnabled && isSweepPlaying) {
                stopSweep();
            }
        }
        
        // ادامه کنترل وقفه
        if (isAudioPlaying && pauseEnabled) {
            pauseInterval = setTimeout(() => {
                executePauseCycle(onTime, offTime, cycleTime);
            }, 100); // بررسی هر 100 میلی‌ثانیه
        }
    }

    function stopPauseControl() {
        if (pauseInterval) {
            clearTimeout(pauseInterval);
            pauseInterval = null;
        }
        isPauseActive = false;
        
        // اگر صدا قطع شده بود، دوباره روشن کن
        if (gainNode && isAudioPlaying) {
            const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
            gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
        }
    }

    /* ---------- Real-time Audio Generation ---------- */
    function ensureAudioContext(){
        if(!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate});
            } catch (error) {
                showError('مرورگر شما از Web Audio API پشتیبانی نمی‌کند');
                return false;
            }
        }
        return true;
    }

    function playSoundWithPause() {
        if (!ensureAudioContext()) return;
        
        if (isAudioPlaying) {
            stopSound();
        }
        
        try {
            // ایجاد نودهای صوتی
            gainNode = audioCtx.createGain();
            
            const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
            gainNode.gain.value = vol;
            
            // برای انواع موج‌های نویز، از BufferSource استفاده می‌کنیم
            if (waveType === 'noise' || waveType === 'pink_noise' || waveType === 'brown_noise') {
                // ایجاد نویز سفید
                const bufferSize = audioCtx.sampleRate * 2;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                
                if (waveType === 'noise') {
                    // نویز سفید
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }
                } else if (waveType === 'pink_noise') {
                    // نویز صورتی
                    const pinkBuffer = generatePinkNoise();
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = pinkBuffer[i % pinkBuffer.length];
                    }
                } else if (waveType === 'brown_noise') {
                    // نویز قهوه‌ای
                    const brownBuffer = generateBrownNoise();
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = brownBuffer[i % brownBuffer.length];
                    }
                }
                
                noiseSource = audioCtx.createBufferSource();
                noiseSource.buffer = buffer;
                noiseSource.loop = true;
                noiseSource.connect(gainNode);
                noiseSource.start();
                oscillator = noiseSource;
            } else {
                // برای موج‌های معمولی از Oscillator استفاده می‌کنیم
                oscillator = audioCtx.createOscillator();
                
                // تنظیم نوع موج
                switch(waveType) {
                    case 'sine':
                        oscillator.type = 'sine';
                        break;
                    case 'square':
                        oscillator.type = 'square';
                        break;
                    case 'modified_square':
                        oscillator.type = 'square';
                        break;
                    case 'triangle':
                        oscillator.type = 'triangle';
                        break;
                    case 'sawtooth':
                        oscillator.type = 'sawtooth';
                        break;
                    default:
                        oscillator.type = 'sine';
                }
                
                // تنظیم فرکانس اولیه
                const freq = sweepEnabled ? (+sweepStart.value || 0.5) : 
                             (randomEnabled && randomFreqEnabled ? currentRandomFreq : (+frequencyInput.value || 50));
                oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
                
                oscillator.connect(gainNode);
                oscillator.start();
            }
            
            gainNode.connect(audioCtx.destination);
            
            audioStartTime = audioCtx.currentTime;
            isAudioPlaying = true;
            
            // اگر وقفه فعال است، کنترل وقفه را شروع کن
            if (pauseEnabled) {
                startPauseControl();
            } else {
                // شروع Sweep در صورت فعال بودن
                if (sweepEnabled && oscillator && waveType !== 'noise' && waveType !== 'pink_noise' && waveType !== 'brown_noise') {
                    startSweep();
                }
            }
            
        } catch (error) {
            console.error('خطا در پخش صدا:', error);
            showError('خطا در پخش صدا. لطفاً مرورگر خود را بروزرسانی کنید.');
            stopAnimation();
            stopRandomChanges();
            stopSweep();
            stopPauseControl();
        }
    }

    function stopSound() {
        stopPauseControl();
        
        if (oscillator) {
            try {
                oscillator.stop();
                oscillator.disconnect();
            } catch (e) {
                // ممکن است قبلاً متوقف شده باشد
            }
            oscillator = null;
        }
        if (gainNode) {
            gainNode.disconnect();
            gainNode = null;
        }
        if (noiseSource) {
            try {
                noiseSource.stop();
                noiseSource.disconnect();
            } catch (e) {
                // ممکن است قبلاً متوقف شده باشد
            }
            noiseSource = null;
        }
        isAudioPlaying = false;
        stopSweep();
        stopRandomChanges();
    }

    /* ---------- Theme definitions & handlers ---------- */
    const THEMES = {
        dark: {
            '--bg':'#0a1929','--bg-dark':'#071220',
            '--card':'#0f2438','--card-dark':'#0a1c2e',
            '--accent':'#00e5ff','--accent-dark':'#00b8d4','--accent-glow':'rgba(0, 229, 255, 0.3)',
            '--muted':'#8fa3b7','--text':'#e3f2fd',
            '--btn':'#1a3a5a','--menu-bg':'#0d2a42','--menu-hover':'#1a3a5a',
            '--canvas-bg':'#071220','--canvas-grid':'rgba(255,255,255,0.08)','--canvas-accent':'#00e5ff','--canvas-text':'rgba(255,255,255,0.9)'
        },
        light: {
            '--bg':'#f5f5f5','--bg-dark':'#e0e0e0',
            '--card':'#ffffff','--card-dark':'#f0f0f0',
            '--accent':'#2196f3','--accent-dark':'#1976d2','--accent-glow':'rgba(33, 150, 243, 0.3)',
            '--muted':'#757575','--text':'#212121',
            '--btn':'#e0e0e0','--menu-bg':'#f5f5f5','--menu-hover':'#e0e0e0',
            '--canvas-bg':'#ffffff','--canvas-grid':'rgba(0,0,0,0.08)','--canvas-accent':'#2196f3','--canvas-text':'#212121'
        },
        windows: {
            '--bg':'#1e3a5f','--bg-dark':'#0f2a4f',
            '--card':'#2a4a7a','--card-dark':'#1a3a6a',
            '--accent':'#0078d4','--accent-dark':'#0063b1','--accent-glow':'rgba(0, 120, 212, 0.3)',
            '--muted':'#a6c7e3','--text':'#f3f2f1',
            '--btn':'#2a4a7a','--menu-bg':'#1e3a5f','--menu-hover':'#2a4a7a',
            '--canvas-bg':'#0f2a4f','--canvas-grid':'rgba(255,255,255,0.08)','--canvas-accent':'#0078d4','--canvas-text':'#f3f2f1'
        }
    };

    function applyTheme(id){
        const t = THEMES[id];
        if(!t) return;
        Object.keys(t).forEach(k=>{
            document.documentElement.style.setProperty(k, t[k]);
        });
        document.querySelectorAll('.theme-chip').forEach(el=> el.classList.toggle('active', el.dataset.theme===id));
        try{ localStorage.setItem('waveTheme', id); }catch(e){}
        drawStaticPreview();
    }

    document.querySelectorAll('.theme-chip').forEach(ch=>{
        ch.addEventListener('click', ()=> applyTheme(ch.dataset.theme));
    });

    (function(){
        let saved=null;
        try{ saved=localStorage.getItem('waveTheme'); }catch(e){}
        applyTheme(saved && THEMES[saved] ? saved : 'dark');
    })();

    /* ---------- drawStaticPreview ---------- */
    function drawStaticPreview() {
        if (isPlaying) return;
        
        const styles = getComputedStyle(document.documentElement);
        const canvasBg = (styles.getPropertyValue('--canvas-bg') || '#071220').trim();
        const canvasGrid = (styles.getPropertyValue('--canvas-grid') || 'rgba(255,255,255,0.08)').trim();
        const canvasAccent = (styles.getPropertyValue('--canvas-accent') || '#00e5ff').trim();
        const canvasText = (styles.getPropertyValue('--canvas-text') || 'rgba(255,255,255,0.9)').trim();

        const cssW=canvas.clientWidth||800;
        const cssH=canvas.clientHeight||280;
        
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle=canvasBg;
        ctx.fillRect(0,0,cssW,cssH);
        
        ctx.beginPath();
        ctx.strokeStyle=canvasGrid;
        ctx.lineWidth=1;
        ctx.moveTo(0,cssH/2);
        ctx.lineTo(cssW,cssH/2);
        ctx.stroke();

        // محاسبه فرکانس برای نمایش
        let displayFreq;
        if (sweepEnabled) {
            const sweepStartVal = +sweepStart.value || 0.5;
            const sweepEndVal = +sweepEnd.value || 100;
            // برای نمایش استاتیک، فرکانس متوسط را نشان می‌دهیم
            displayFreq = (sweepStartVal + sweepEndVal) / 2;
        } else if (randomEnabled && randomFreqEnabled) {
            displayFreq = currentRandomFreq;
        } else {
            displayFreq = +frequencyInput.value || 50;
        }

        const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
        const type=waveType;
        const samples=Math.floor(cssW);
        const tOnVal=+tOn.value||5;
        const tOffVal=+tOff.value||5;
        const pauseVal = pauseEnabled ? (+pauseDuration.value || 3) : 0;
        
        const totalDuration = pauseVal || 2;
        const onDuration = (tOnVal / TOTAL) * totalDuration;
        const offDuration = (tOffVal / TOTAL) * totalDuration;
        const cycleDuration = onDuration + offDuration;
        
        ctx.beginPath();
        ctx.lineWidth=2;
        ctx.strokeStyle=canvasAccent;
        
        for(let x=0; x<samples; x++){
            const t = x / samples * totalDuration;
            const timeInCycle = t % cycleDuration;
            const isOn = pauseEnabled ? (timeInCycle < onDuration) : true;
            
            // محاسبه فرکانس برای هر نقطه
            let currentFreq = displayFreq;
            if (sweepEnabled) {
                const sweepStartVal = +sweepStart.value || 0.5;
                const sweepEndVal = +sweepEnd.value || 100;
                const sweepDurationVal = +sweepDuration.value || 5;
                
                const progress = x / samples;
                currentFreq = sweepStartVal + (sweepEndVal - sweepStartVal) * progress;
            }
            
            let phase;
            if (!pauseEnabled && !sweepEnabled && !randomEnabled) {
                phase = (x / samples) * displayFreq * 10;
            } else {
                phase = t * currentFreq;
            }
            
            let s = 0;
            
            if(isOn) {
                s = generateWaveSample(phase, type);
            }
            
            const val = s * vol;
            const y = (cssH/2) - val * (cssH/2-8);
            
            if(x===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        }
        
        ctx.stroke();
        
        // نمایش اطلاعات
        let freqDisplayText;
        if (sweepEnabled) {
            const sweepStartVal = +sweepStart.value || 0.5;
            const sweepEndVal = +sweepEnd.value || 100;
            freqDisplayText = `فرکانس: ${sweepStartVal}Hz → ${sweepEndVal}Hz`;
        } else if (randomEnabled && randomFreqEnabled) {
            const freqMin = Math.max(0.5, +randomFreqMin.value || 0.5);
            const freqMax = Math.max(freqMin, +randomFreqMax.value || 100);
            freqDisplayText = `فرکانس: ${displayFreq}Hz (${freqMin}Hz - ${freqMax}Hz رندوم)`;
        } else {
            freqDisplayText = `فرکانس: ${displayFreq}Hz`;
        }
        
        let volDisplayText;
        if (randomEnabled && randomVolEnabled) {
            const volMin = Math.max(0, +randomVolMin.value || 20);
            const volMax = Math.min(100, Math.max(volMin, +randomVolMax.value || 80));
            volDisplayText = `ولوم: ${Math.round(vol * 100)}% (${volMin}% - ${volMax}% رندوم)`;
        } else {
            volDisplayText = `ولوم: ${Math.round(vol * 100)}%`;
        }
        
        let infoText = `موج: ${waveType} — ${freqDisplayText} — ${volDisplayText}`;
        if (pauseEnabled) {
            infoText += ` — T_on/T_off: ${tOn.value}/${tOff.value} — وقفه: ${pauseVal}s`;
        } else {
            infoText += ` — بدون وقفه`;
        }
        if (sweepEnabled && sweepLoopEnabled) {
            infoText += ` — تکرار: فعال`;
        }
        if (randomEnabled) {
            let randomTypes = [];
            if (randomFreqEnabled) randomTypes.push('فرکانس');
            if (randomVolEnabled) randomTypes.push('شدت');
            infoText += ` — حالت رندوم: ${randomTypes.join(' و ')}`;
        }
        
        ctx.fillStyle=canvasText;
        ctx.font='13px Segoe UI, Tahoma, Arial';
        ctx.fillText(infoText, 8, 20);
    }

    /* ---------- drawAnimatedPreview ---------- */
    function drawAnimatedPreview(currentTime) {
        const styles = getComputedStyle(document.documentElement);
        const canvasBg = (styles.getPropertyValue('--canvas-bg') || '#071220').trim();
        const canvasGrid = (styles.getPropertyValue('--canvas-grid') || 'rgba(255,255,255,0.08)').trim();
        const canvasAccent = (styles.getPropertyValue('--canvas-accent') || '#00e5ff').trim();
        const canvasText = (styles.getPropertyValue('--canvas-text') || 'rgba(255,255,255,0.9)').trim();

        const cssW=canvas.clientWidth||800;
        const cssH=canvas.clientHeight||280;
        
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle=canvasBg;
        ctx.fillRect(0,0,cssW,cssH);
        
        ctx.beginPath();
        ctx.strokeStyle=canvasGrid;
        ctx.lineWidth=1;
        ctx.moveTo(0,cssH/2);
        ctx.lineTo(cssW,cssH/2);
        ctx.stroke();

        // محاسبه فرکانس فعلی برای نمایش
        let currentDisplayFreq;
        if (sweepEnabled && isSweepPlaying) {
            currentDisplayFreq = currentSweepFreq;
        } else if (randomEnabled && randomFreqEnabled) {
            currentDisplayFreq = currentRandomFreq;
        } else {
            currentDisplayFreq = +frequencyInput.value || 50;
        }

        const vol = randomEnabled && randomVolEnabled ? (currentRandomVol/100) : ((+volumeInput.value||50)/100);
        const type=waveType;
        const samples=Math.floor(cssW);
        const tOnVal=+tOn.value||5;
        const tOffVal=+tOff.value||5;
        const pauseVal = pauseEnabled ? (+pauseDuration.value || 3) : 0;
        
        const totalDuration = pauseVal || 2;
        const onDuration = (tOnVal / TOTAL) * totalDuration;
        const offDuration = (tOffVal / TOTAL) * totalDuration;
        const cycleDuration = onDuration + offDuration;
        
        ctx.beginPath();
        ctx.lineWidth=2;
        ctx.strokeStyle=canvasAccent;
        
        if (!lastAnimationTime) lastAnimationTime = currentTime;
        const deltaTime = (currentTime - lastAnimationTime) / 1000;
        lastAnimationTime = currentTime;
        
        // تنظیم animationTime بر اساس sweepProgress برای جلوگیری از تداخل
        if (sweepEnabled && isSweepPlaying) {
            // در حالت sweep، از sweepProgress برای محاسبه زمان استفاده می‌کنیم
            animationTime = sweepProgress * (+sweepDuration.value || 5);
        } else {
            animationTime += deltaTime;
        }
        
        // به‌روزرسانی نمایش فرکانس زنده
        currentFreqDisplay.textContent = currentDisplayFreq.toFixed(1);
        
        for(let x=0; x<samples; x++){
            let t, timeInCycle, isOn, currentFreq, currentVol, phase;
            
            if (!pauseEnabled && !sweepEnabled && !randomEnabled) {
                t = x / samples * 2;
                timeInCycle = 0;
                isOn = true;
                currentFreq = currentDisplayFreq;
                currentVol = vol;
                phase = (t + animationTime) * currentFreq * 2 * Math.PI;
            } else {
                t = x / samples * totalDuration;
                timeInCycle = (t + animationTime) % cycleDuration;
                isOn = pauseEnabled ? (timeInCycle < onDuration) : true;
                
                // محاسبه فرکانس برای هر نقطه
                currentFreq = currentDisplayFreq;
                if (sweepEnabled && isSweepPlaying) {
                    // در حالت sweep، فرکانس ثابت است (currentDisplayFreq)
                    currentFreq = currentDisplayFreq;
                }
                
                currentVol = vol;
                
                phase = (t + animationTime) * currentFreq * 2 * Math.PI;
            }
            
            let s = 0;
            
            if(isOn) {
                s = generateWaveSample(phase / (2 * Math.PI), type);
            }
            
            const val = s * currentVol;
            const y = (cssH/2) - val * (cssH/2-8);
            
            if(x===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        }
        
        ctx.stroke();
        
        // نمایش اطلاعات
        let freqDisplayText;
        if (sweepEnabled && isSweepPlaying) {
            const sweepStartVal = +sweepStart.value || 0.5;
            const sweepEndVal = +sweepEnd.value || 100;
            freqDisplayText = `فرکانس: ${currentDisplayFreq.toFixed(1)}Hz (${sweepStartVal}Hz → ${sweepEndVal}Hz)`;
        } else if (randomEnabled && randomFreqEnabled) {
            const freqMin = Math.max(0.5, +randomFreqMin.value || 0.5);
            const freqMax = Math.max(freqMin, +randomFreqMax.value || 100);
            freqDisplayText = `فرکانس: ${currentDisplayFreq.toFixed(1)}Hz (${freqMin}Hz - ${freqMax}Hz رندوم)`;
        } else {
            freqDisplayText = `فرکانس: ${currentDisplayFreq}Hz`;
        }
        
        let volDisplayText;
        if (randomEnabled && randomVolEnabled) {
            const volMin = Math.max(0, +randomVolMin.value || 20);
            const volMax = Math.min(100, Math.max(volMin, +randomVolMax.value || 80));
            volDisplayText = `ولوم: ${Math.round(vol * 100)}% (${volMin}% - ${volMax}% رندوم)`;
        } else {
            volDisplayText = `ولوم: ${Math.round(vol * 100)}%`;
        }
        
        let infoText = `موج: ${waveType} — ${freqDisplayText} — ${volDisplayText}`;
        if (pauseEnabled) {
            infoText += ` — T_on/T_off: ${tOn.value}/${tOff.value} — وقفه: ${pauseVal}s`;
        } else {
            infoText += ` — بدون وقفه`;
        }
        infoText += ` — در حال حرکت`;
        if (sweepEnabled && sweepLoopEnabled) {
            infoText += ` — تکرار: فعال`;
        }
        if (randomEnabled) {
            let randomTypes = [];
            if (randomFreqEnabled) randomTypes.push('فرکانس');
            if (randomVolEnabled) randomTypes.push('شدت');
            infoText += ` — حالت رندوم: ${randomTypes.join(' و ')}`;
        }
        
        ctx.fillStyle=canvasText;
        ctx.font='13px Segoe UI, Tahoma, Arial';
        ctx.fillText(infoText, 8, 20);
        
        if (isPlaying) {
            animationId = requestAnimationFrame(drawAnimatedPreview);
        }
    }

    /* ---------- Animation ---------- */
    function startAnimation() {
        if (isPlaying) return;
        
        isPlaying = true;
        lastAnimationTime = 0;
        animationTime = 0;
        
        waveStatus.textContent = 'در حال پخش';
        waveStatus.className = 'status-indicator status-playing';
        waveStatus.innerHTML = '<i class="fas fa-play"></i> در حال پخش';
        playBtn.innerHTML = '<i class="fas fa-pause"></i> در حال پخش...';
        playBtn.disabled = true;
        
        animationId = requestAnimationFrame(drawAnimatedPreview);
    }

    function stopAnimation() {
        if (!isPlaying) return;
        
        isPlaying = false;
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }

        waveStatus.textContent = 'متوقف';
        waveStatus.className = 'status-indicator status-stopped';
        waveStatus.innerHTML = '<i class="fas fa-pause"></i> متوقف';
        playBtn.innerHTML = '<i class="fas fa-play"></i> پخش صدا و موج';
        playBtn.disabled = false;
        
        drawStaticPreview();
    }

    /* ---------- buttons ---------- */
    playBtn.addEventListener('click', ()=>{
        if (!ensureAudioContext()) return;
        
        if(audioCtx.state==='suspended') {
            audioCtx.resume().catch(error => {
                showError('خطا در فعال کردن صدا: ' + error.message);
                return;
            });
        }
        
        playSoundWithPause();
        startAnimation();
        
        // شروع تغییرات رندوم در صورت فعال بودن
        if (randomEnabled) {
            startRandomChanges();
        }
    });

    stopBtn.addEventListener('click', ()=>{
        stopSound();
        stopAnimation();
        stopRandomChanges();
    });

    // فعال کردن دکمه ذخیره
    saveBtn.addEventListener('click', ()=>{
        if (isPlaying) {
            showError('لطفاً ابتدا صدا را متوقف کنید، سپس فایل را ذخیره نمایید.');
            return;
        }
        
        try {
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال تولید فایل...';
            saveBtn.disabled = true;
            
            // تولید فایل WAV
            generateWavFile();
            
            setTimeout(() => {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ذخیره WAV';
                saveBtn.disabled = false;
            }, 1000);
            
        } catch (error) {
            console.error('خطا در تولید فایل WAV:', error);
            showError('خطا در تولید فایل صوتی. لطفاً دوباره امتحان کنید.');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> ذخیره WAV';
            saveBtn.disabled = false;
        }
    });

    /* ---------- init ---------- */
    function init(){
        fixCanvasSize();
        updateTonToffInfo();
        drawStaticPreview();
        
        // تنظیم مقادیر پیش‌فرض برای sweep و random
        sweepStart.value = 0.5;
        sweepEnd.value = 100;
        randomFreqMin.value = 0.5;
        randomFreqMax.value = 100;
        
        // بررسی پشتیبانی از Web Audio API
        if (!window.AudioContext && !window.webkitAudioContext) {
            showError('مرورگر شما از Web Audio API پشتیبانی نمی‌کند. برخی قابلیت‌ها ممکن است کار نکنند.');
        }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>